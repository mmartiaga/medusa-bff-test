name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'Which service to rollback'
        required: true
        type: choice
        options:
          - gateway
          - products
          - orders
          - content
          - customers
      target_version:
        description: >-
          Version to rollback to (e.g., 1.2.3, or leave
          empty to list available versions)
        required: false
        type: string
      confirm:
        description: 'Type "rollback" to confirm production rollback'
        required: true
        type: string

permissions:
  contents: read
  deployments: write
  packages: read

concurrency:
  group: rollback-${{ inputs.app }}-production
  cancel-in-progress: false

jobs:
  validate:
    name: Validate rollback request
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.determine-image.outputs.image_tag }}
      service_name: ${{ steps.determine-image.outputs.service_name }}
      version: ${{ steps.determine-image.outputs.version }}
      is_subgraph: ${{ steps.determine-image.outputs.is_subgraph }}
      package_name: ${{ steps.determine-image.outputs.package_name }}
    steps:
      - name: Validate confirmation
        env:
          CONFIRM: ${{ inputs.confirm }}
        run: |
          if [ "$CONFIRM" != "rollback" ]; then
            echo "::error::Confirmation failed." \
                 "You must type 'rollback' to proceed."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch git tags
        run: git fetch --tags

      - name: Determine target version and service type
        id: determine-image
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APP: ${{ inputs.app }}
          TARGET_VERSION: ${{ inputs.target_version }}
        run: |
          APP="$APP"
          TARGET_VERSION="$TARGET_VERSION"

          case "$APP" in
            gateway)
              PACKAGE_NAME="@gfed-medusa-bff/gateway"
              IS_SUBGRAPH="false"
              ;;
            products|orders|content|customers)
              PACKAGE_NAME="@gfed-medusa-bff/$APP"
              IS_SUBGRAPH="true"
              ;;
            *)
              echo "::error::Invalid app: $APP"
              exit 1
              ;;
          esac

          echo "Available versions for $PACKAGE_NAME:"
          AVAILABLE_VERSIONS=$(git tag -l "$PACKAGE_NAME@*" | \
            sed "s/$PACKAGE_NAME@//" | sort -V -r)
          echo "$AVAILABLE_VERSIONS"

          if [ -z "$TARGET_VERSION" ]; then
            echo "::error::No version provided. Available versions:"
            echo "$AVAILABLE_VERSIONS" | head -10
            echo "::error::Please specify a version from the list above."
            exit 1
          fi

          GIT_TAG="$PACKAGE_NAME@$TARGET_VERSION"
          if ! git tag -l "$GIT_TAG" | grep -q .; then
            echo "::error::Version $TARGET_VERSION does not exist for $APP"
            echo "::error::Available versions:"
            echo "$AVAILABLE_VERSIONS" | head -10
            exit 1
          fi
          echo "✓ Git tag exists: $GIT_TAG"

          TAG_COMMIT=$(git rev-list -n 1 "$GIT_TAG")
          COMMIT_DATE=$(git show -s --format=%ci "$TAG_COMMIT")
          COMMIT_TIMESTAMP=$(git show -s --format=%ct "$TAG_COMMIT")
          CURRENT_TIMESTAMP=$(date +%s)
          DAYS_OLD=$(( (CURRENT_TIMESTAMP - COMMIT_TIMESTAMP) / 86400 ))

          echo "::notice::Version $TARGET_VERSION details:"
          echo "::notice::• Committed: $COMMIT_DATE ($DAYS_OLD days ago)"
          echo "::notice::• Git SHA: $TAG_COMMIT"

          echo "::warning::⚠️  Rollback Safety Notices:"
          echo "::warning::• Rolling back to version" \
               "$TARGET_VERSION from $DAYS_OLD days ago"
          echo "::warning::• Rollback affects the $APP service"
          if [ "$IS_SUBGRAPH" = "true" ]; then
            echo "::warning::• GraphQL schema will be" \
                 "rolled back to match this version"
          fi
          echo "::warning::  Shared packages remain at" \
               "current versions"

          if [ "$DAYS_OLD" -gt 30 ]; then
            echo "::warning::• ⚠️  HIGH RISK:" \
                 "Version is >30 days old"
            echo "::warning::  May have" \
                 "database/infrastructure incompatibilities"
            echo "::warning::• Test thoroughly after rollback"
          fi

          TAG_SHA=$(git rev-list -n 1 "$GIT_TAG")

          SERVICE_NAME="$APP-prod"
          IMAGE_TAG="ghcr.io/${{ github.repository }}/$APP:$TAG_SHA"
          {
            echo "image_tag=$IMAGE_TAG"
            echo "version=$TARGET_VERSION"
            echo "service_name=$SERVICE_NAME"
            echo "is_subgraph=$IS_SUBGRAPH"
            echo "package_name=$PACKAGE_NAME"
          } >> "$GITHUB_OUTPUT"
          echo "Rolling back to version: $TARGET_VERSION"
          echo "Using Docker image: $IMAGE_TAG"

      - name: Validate Docker image exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ steps.determine-image.outputs.image_tag }}
          APP: ${{ inputs.app }}
          VERSION: ${{ steps.determine-image.outputs.version }}
          REPOSITORY: ${{ github.repository }}
          REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          IMAGE="$IMAGE_TAG"
          APP="$APP"
          VERSION="$VERSION"

          SHA="${IMAGE##*:}"

          REPO_NAME=$(echo "$REPOSITORY" | cut -d'/' -f2)
          PACKAGE_NAME="$REPO_NAME/$APP"
          PACKAGE_NAME_ENCODED="${PACKAGE_NAME//\//%2F}"

          echo "Checking if image exists: $IMAGE"
          echo "Package: $PACKAGE_NAME"
          echo "Version: $VERSION"
          echo "SHA: $SHA"

          API_URL="https://api.github.com/users"
          API_URL="$API_URL/$REPOSITORY_OWNER"
          API_URL="$API_URL/packages/container/$PACKAGE_NAME_ENCODED/versions"
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::warning::Unable to verify image existence" \
                 "via API (HTTP $HTTP_CODE)"
            echo "::warning::Proceeding with deployment -" \
                 "Render will fail if image doesn't exist"
          else
            TAG_EXISTS=$(echo "$BODY" | jq -r --arg tag "$SHA" \
              'any(.[]; .metadata.container.tags[]? == $tag)')

            if [ "$TAG_EXISTS" = "true" ]; then
              echo "✓ Docker image exists in GHCR (SHA: $SHA)"
            else
              echo "::error::Docker image not found: $IMAGE"
              echo "::error::The image with SHA $SHA may not exist."
              echo "::error::This could happen if:"
              echo "::error::  1. The build failed for this commit"
              echo "::error::  2. The image was deleted from GHCR"
              echo "::error::  3. The git tag points to a commit" \
                   "that was never deployed"
              echo "::error::Please verify the image exists or" \
                   "choose a more recent version."
              exit 1
            fi
          fi

  rollback-deployment:
    name: >-
      Rollback ${{ inputs.app }} to v${{
      needs.validate.outputs.version }} in production
    needs: validate
    uses: ./.github/workflows/_deploy-render.yaml
    with:
      app: ${{ needs.validate.outputs.service_name }}
      image: ${{ needs.validate.outputs.image_tag }}
    secrets:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

  publish-subgraph:
    name: Publish rolled-back subgraph schema
    needs: [validate, rollback-deployment]
    if: needs.validate.outputs.is_subgraph == 'true' && needs.rollback-deployment.result == 'success'
    uses: ./.github/workflows/_publish-subgraph.yaml
    with:
      environment: prod
      subgraph_name: ${{ inputs.app }}
    secrets:
      SCHEMA_REGISTRY_REPO: ${{ secrets.SCHEMA_REGISTRY_REPO }}
      SCHEMA_REGISTRY_TOKEN: ${{ secrets.SCHEMA_REGISTRY_TOKEN }}
      SUBGRAPH_URL: >-
        ${{ inputs.app == 'products' && secrets.PRODUCTS_URL ||
            inputs.app == 'orders' && secrets.ORDERS_URL ||
            inputs.app == 'content' && secrets.CONTENT_URL ||
            inputs.app == 'customers' && secrets.CUSTOMERS_URL }}

  publish-supergraph:
    name: Publish supergraph after rollback
    needs: [validate, rollback-deployment, publish-subgraph]
    if: needs.validate.outputs.is_subgraph == 'true' && needs.rollback-deployment.result == 'success' && needs.publish-subgraph.result == 'success'
    uses: ./.github/workflows/_publish-supergraph.yaml
    with:
      environment: prod
    secrets:
      SCHEMA_REGISTRY_REPO: ${{ secrets.SCHEMA_REGISTRY_REPO }}
      SCHEMA_REGISTRY_TOKEN: ${{ secrets.SCHEMA_REGISTRY_TOKEN }}
      PRODUCTS_URL: ${{ secrets.PRODUCTS_URL }}
      CUSTOMERS_URL: ${{ secrets.CUSTOMERS_URL }}
      CONTENT_URL: ${{ secrets.CONTENT_URL }}
      ORDERS_URL: ${{ secrets.ORDERS_URL }}
      SUPERGRAPH_RELOAD_URL: ${{ secrets.SUPERGRAPH_RELOAD_URL }}
      SUPERGRAPH_RELOAD_TOKEN: ${{ secrets.SUPERGRAPH_RELOAD_TOKEN }}

  notify:
    name: Notify rollback result
    needs: [validate, rollback-deployment, publish-subgraph, publish-supergraph]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Rollback successful
        if: needs.rollback-deployment.result == 'success'
        run: |
          echo "::notice::✓ Rollback completed successfully"
          echo "Service: ${{ needs.validate.outputs.service_name }}"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "Image: ${{ needs.validate.outputs.image_tag }}"
          IS_SUBGRAPH="${{ needs.validate.outputs.is_subgraph }}"
          if [ "$IS_SUBGRAPH" = "true" ]; then
            echo "GraphQL schema has been rolled back" \
                 "to match this version"
          fi

      - name: Rollback failed
        if: needs.rollback-deployment.result == 'failure'
        run: |
          echo "::error::✗ Rollback failed"
          echo "Service: ${{ needs.validate.outputs.service_name }}"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "Image: ${{ needs.validate.outputs.image_tag }}"
          echo "Check the logs above for details"
          exit 1
